<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calendario Interactivo</title>
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
    <style>
        body {font-family: Arial, sans-serif; margin: 0; padding: 0; background:#f4f4f4;}
        #calendar {max-width: 900px; margin: 40px auto; background:white; padding:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,.1);}
        .fc-event {cursor:pointer;}
        /* Modal styles */
        #modalOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;z-index:10;}
        #modal{background:white;border-radius:8px;padding:20px;width:90%;max-width:400px;box-shadow:0 2px 10px rgba(0,0,0,.3);} 
        #modal h2{margin-top:0;} 
        .form-group{margin-bottom:15px;} 
        label{display:block;font-weight:bold;margin-bottom:5px;} 
        input[type=text],input[type=datetime-local],textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;}
        button{padding:10px 15px;background:#28a745;color:white;border:none;border-radius:4px;cursor:pointer;margin-right:5px;} 
        button:hover{background:#218838;} 
        .btn-danger{background:#dc3545;} 
        .btn-danger:hover{background:#c82333;} 
    </style>
</head>
<body>
<div id="calendar"></div>
<!-- Modal for event creation/edit -->
<div id="modalOverlay">
  <div id="modal">
    <h2 id="modalTitle">Nuevo Evento</h2>
    <form id="eventForm">
      <input type="hidden" id="eventId" />
      <div class="form-group"><label for="title">Título</label><input type="text" id="title" required /></div>
      <div class="form-group"><label for="description">Descripción</label><textarea id="description"></textarea></div>
      <div class="form-group"><label for="start">Inicio</label><input type="datetime-local" id="start" required /></div>
      <div class="form-group"><label for="end">Fin</label><input type="datetime-local" id="end" required /></div>
      <div class="form-group"><label for="color">Color</label><input type="color" id="color" value="#3788d8" /></div>
      <button type="submit">Guardar</button>
      <button type="button" id="cancelBtn">Cancelar</button>
    </form>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.min.js"></script>
<script>
const calendarEl = document.getElementById('calendar');
let calendar;

// Utility to format date for API (ISO 8601)
function toIso(date){return new Date(date).toISOString();}

// Fetch events for current month view
async function fetchEvents(start, end){
    try{
        const res = await fetch(`/api/events?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`);
        if(!res.ok){throw new Error('Error al cargar eventos');}
        const data = await res.json();
        return data.map(ev=>({id:ev.id,title:ev.titulo,start:ev.fecha_inicio,end:ev.fecha_fin,color:ev.color||'#3788d8',extendedProps:{description:ev.descripcion}}));
    }catch(err){alert(err.message);return [];}
}

// Initialize calendar
function initCalendar(){
    calendar = new FullCalendar.Calendar(calendarEl,{
        initialView:'dayGridMonth',
        locale:'es',
        editable:true,
        selectable:true,
        eventDrop:{
            async success(arg){
                const ev=arg.event;
                await updateEvent(ev.id, {fecha_inicio:ev.startStr, fecha_fin:ev.endStr});
                calendar.refetchEvents();
            },
            failure(){alert('No se pudo mover el evento');}
        },
        eventClick:{
            async info=>{openModal(info.event);}
        },
        dateClick:{
            selectInfo=>{openModal(null,selectInfo.dateStr);} 
        },
        events:async function(fetchInfo, successCallback){
            const events = await fetchEvents(fetchInfo.startStr, fetchInfo.endStr);
            successCallback(events);
        }
    });
    calendar.render();
}

// Modal handling
const modalOverlay=document.getElementById('modalOverlay');
const eventForm=document.getElementById('eventForm');
function openModal(event=null, dateStr=null){
    document.getElementById('modalTitle').textContent = event? 'Editar Evento' : 'Nuevo Evento';
    document.getElementById('eventId').value = event?.id||'';
    document.getElementById('title').value = event?.title||'';
    document.getElementById('description').value = event?.extendedProps.description||'';
    if(event){
        document.getElementById('start').value = event.startStr.slice(0,16);
        document.getElementById('end').value = event.endStr?event.endStr.slice(0,16):document.getElementById('start').value;
    }else{
        const now=new Date(dateStr);now.setHours(9,0,0,0);
        const later=new Date(now);later.setHours(10,0,0,0);
        document.getElementById('start').value=now.toISOString().slice(0,16);
        document.getElementById('end').value=later.toISOString().slice(0,16);
    }
    modalOverlay.style.display='flex';
}
function closeModal(){modalOverlay.style.display='none';eventForm.reset();}

document.getElementById('cancelBtn').addEventListener('click',closeModal);
// Submit form for create/update
async function submitEvent(e){e.preventDefault();
    const id=document.getElementById('eventId').value;
    const payload={
        titulo:document.getElementById('title').value,
        descripcion:document.getElementById('description').value,
        fecha_inicio:toIso(document.getElementById('start').value),
        fecha_fin:toIso(document.getElementById('end').value),
        color:document.getElementById('color').value
    };
    try{
        const url=id?`/api/events/${id}`:'/api/events';
        const method=id?'PUT':'POST';
        const res=await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        if(!res.ok){throw new Error('Error al guardar evento');}
        closeModal();calendar.refetchEvents();
    }catch(err){alert(err.message);}
}

// Delete event from modal details view (when editing)
async function deleteEvent(id){if(!confirm('Eliminar evento?'))return;try{const res=await fetch(`/api/events/${id}`,{method:'DELETE'});if(!res.ok)throw new Error('Error al eliminar');closeModal();calendar.refetchEvents();}catch(err){alert(err.message);} }

// Update event dates via PUT (drag & drop)
async function updateEvent(id, data){try{const res=await fetch(`/api/events/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});if(!res.ok)throw new Error('Error al actualizar');}catch(err){alert(err.message);} }

// Override modal for edit to include delete button
function openModal(event=null, dateStr=null){
    document.getElementById('modalTitle').textContent = event? 'Editar Evento' : 'Nuevo Evento';
    document.getElementById('eventId').value = event?.id||'';
    document.getElementById('title').value = event?.title||'';
    document.getElementById('description').value = event?.extendedProps.description||'';
    if(event){
        document.getElementById('start').value = event.startStr.slice(0,16);
        document.getElementById('end').value = event.endStr?event.endStr.slice(0,16):document.getElementById('start').value;
    }else{
        const now=new Date(dateStr);now.setHours(9,0,0,0);
        const later=new Date(now);later.setHours(10,0,0,0);
        document.getElementById('start').value=now.toISOString().slice(0,16);
        document.getElementById('end').value=later.toISOString().slice(0,16);
    }
    modalOverlay.style.display='flex';
    // Add delete button if editing
    const form=document.getElementById('eventForm');
    let delBtn = document.getElementById('deleteBtn');
    if(event){
        if(!delBtn){
            delBtn=document.createElement('button');delBtn.id='deleteBtn';delBtn.type='button';delBtn.className='btn-danger';delBtn.textContent='Eliminar';form.appendChild(delBtn);
            delBtn.addEventListener('click',()=>deleteEvent(event.id));
        }
    }else if(delBtn){delBtn.remove();}
}

initCalendar();
// Form submit handler
eventForm.addEventListener('submit',submitEvent);
</script>
</body>
</html>