<!DOCTYPE html>\n<html lang=\"es\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Calendario Interactivo</title>\n    <!-- FullCalendar CSS -->\n    <link href=\"https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css\" rel=\"stylesheet\">\n    <style>\n        body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f4f4f4;}\n        #calendar{max-width:900px;margin:40px auto;background:white;box-shadow:0 2px 8px rgba(0,0,0,.1);padding:10px;border-radius:5px;}\n        /* Modal styles */\n        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);justify-content:center;align-items:center;}\n        .modal.active{display:flex;}\n        .modal-content{background:white;padding:20px;border-radius:5px;width:90%;max-width:400px;position:relative;}\n        .close-btn{position:absolute;top:10px;right:10px;font-size:1.2rem;cursor:pointer;}\n        label{display:block;margin-top:10px;}\n        input,textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;margin-top:5px;}\n        button{margin-top:15px;padding:10px 15px;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;}\n        button:hover{background:#0056b3;}\n    </style>\n</head>\n<body>\n<div id=\"calendar\"></div>\n<!-- Modal for create/edit -->\n<div id=\"eventModal\" class=\"modal\">\n  <div class=\"modal-content\">\n    <span class=\"close-btn\" onclick=\"closeModal()\">&times;</span>\n    <h3 id=\"modalTitle\">Nuevo Evento</h3>\n    <label for=\"titleInput\">Título:</label>\n    <input type=\"text\" id=\"titleInput\">\n    <label for=\"descInput\">Descripción:</label>\n    <textarea id=\"descInput\"></textarea>\n    <label for=\"startInput\">Fecha Inicio:</label>\n    <input type=\"datetime-local\" id=\"startInput\">\n    <label for=\"endInput\">Fecha Fin:</label>\n    <input type=\"datetime-local\" id=\"endInput\">\n    <label for=\"colorInput\">Color:</label>\n    <input type=\"color\" id=\"colorInput\" value=\"#3788d8\">\n    <button id=\"saveBtn\">Guardar</button>\n  </div>\n</div>\n<script src=\"https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js\"></script>\n<script>\nlet calendar;\nconst modal=document.getElementById('eventModal');\nconst saveBtn=document.getElementById('saveBtn');\nlet currentEvent=null;\nfunction openModal(event){\n    modal.classList.add('active');\n    if(event){\n        document.getElementById('modalTitle').textContent='Editar Evento';\n        document.getElementById('titleInput').value=event.title;\n        document.getElementById('descInput').value=event.extendedProps.descripcion||'';\n        document.getElementById('startInput').value=new Date(event.start).toISOString().slice(0,16);\n        document.getElementById('endInput').value=new Date(event.end).toISOString().slice(0,16);\n        document.getElementById('colorInput').value=event.backgroundColor||'#3788d8';\n        currentEvent=event;\n    }else{\n        document.getElementById('modalTitle').textContent='Nuevo Evento';\n        document.getElementById('titleInput').value='';\n        document.getElementById('descInput').value='';\n        const now=new Date();\n        document.getElementById('startInput').value=now.toISOString().slice(0,16);\n        document.getElementById('endInput').value=now.toISOString().slice(0,16);\n        document.getElementById('colorInput').value='#3788d8';\n        currentEvent=null;\n    }\n}\nfunction closeModal(){modal.classList.remove('active');}\nsaveBtn.addEventListener('click',()=>{\n    const title=document.getElementById('titleInput').value.trim();\n    if(!title){alert('Título es requerido.');return;}\n    const data={titulo:title,descripcion:document.getElementById('descInput').value,color:document.getElementById('colorInput').value};\n    data.fecha_inicio=document.getElementById('startInput').value;\n    data.fecha_fin=document.getElementById('endInput').value;\n    if(currentEvent){\n        // Update existing event via PUT\n        fetch(`/api/events/${currentEvent.id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)})\n            .then(r=>{if(!r.ok)return r.json().then(e=>{throw e});return r.json();})\n            .then(updated=>{calendar.refetchEvents();closeModal();})\n            .catch(err=>alert('Error al actualizar: '+(err.error||err)));\n    }else{\n        // Create new event via POST\n        fetch('/api/events',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)})\n            .then(r=>{if(!r.ok)return r.json().then(e=>{throw e});return r.json();})\n            .then(created=>{calendar.refetchEvents();closeModal();})\n            .catch(err=>alert('Error al crear: '+(err.error||err)));\n    }\n});\nfunction initCalendar(){\n    const calendarEl=document.getElementById('calendar');\n    calendar=new FullCalendar.Calendar(calendarEl,{\n        initialView:'dayGridMonth',\n        editable:true,\n        selectable:true,\n        eventClick:info=>{openModal(info.event);},\n        dateClick:info=>{openModal();},\n        eventDrop:info=>{\n            const data={fecha_inicio:info.event.start.toISOString(),fecha_fin:info.event.end?info.event.end.toISOString():info.event.start.toISOString()};\n            fetch(`/api/events/${info.event.id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)})\n                .then(r=>{if(!r.ok)return r.json().then(e=>{throw e});return r.json();})\n                .catch(err=>{alert('Error al mover evento: '+(err.error||err));calendar.refetchEvents();});\n        },\n        events:{url:'/api/events',extraParams:function(){const start=document.getElementById('calendar').querySelector('.fc-toolbar-title');return {};},failure:function() {alert('No se pudieron cargar eventos.');}}\n    });\n    calendar.render();\n}\nfunction loadEventsForMonth(start,end){\n    fetch(`/api/events?start=${start}&end=${end}`)\n        .then(r=>{if(!r.ok)return r.json().then(e=>{throw e});return r.json();})\n        .then(events=>{calendar.removeAllEvents();events.forEach(ev=>{calendar.addEvent({id:ev.id,title:ev.titulo,start:ev.fecha_inicio,end:ev.fecha_fin,backgroundColor:ev.color||'#3788d8',extendedProps:{descripcion:ev.descripcion}});});})\n        .catch(err=>alert('Error al cargar eventos: '+(err.error||err)));\n}\ndocument.addEventListener('DOMContentLoaded',()=>{initCalendar();const today=new Date();const monthStart=new Date(today.getFullYear(),today.getMonth(),1).toISOString();const monthEnd=new Date(today.getFullYear(),today.getMonth()+1,0).toISOString();loadEventsForMonth(monthStart,monthEnd);});\n</script>\n</body>\n</html>