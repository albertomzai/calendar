<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Interactivo</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">

    <style>
      #calendar { max-width: 900px; margin: 0 auto; }
      .fc-event { cursor: pointer; }
    </style>
</head>
<body>

    <div class="container py-4">
        <h1 class="mb-4 text-center" data-testid="page-title">Calendario Interactivo</h1>

        <!-- Calendario -->
        <div id="calendar-view" data-testid="calendar-container"></div>

        <!-- Modal de Creación/Edición -->
        <div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel" data-testid="modal-title">Nuevo Evento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form id="eventForm">
                  <input type="hidden" id="event-id" name="id">

                  <div class="mb-3">
                    <label for="event-title" class="form-label" data-testid="label-title">Título</label>
                    <input type="text" class="form-control" id="event-title" name="title" required data-testid="input-title">
                  </div>

                  <div class="mb-3">
                    <label for="event-description" class="form-label" data-testid="label-description">Descripción</label>
                    <textarea class="form-control" id="event-description" name="description" rows="3" data-testid="input-description"></textarea>
                  </div>

                  <div class="mb-3">
                    <label for="event-start" class="form-label" data-testid="label-start">Fecha de Inicio</label>
                    <input type="datetime-local" class="form-control" id="event-start" name="start" required data-testid="input-start">
                  </div>

                  <div class="mb-3">
                    <label for="event-end" class="form-label" data-testid="label-end">Fecha de Fin</label>
                    <input type="datetime-local" class="form-control" id="event-end" name="end" required data-testid="input-end">
                  </div>

                  <div class="mb-3">
                    <label for="event-color" class="form-label" data-testid="label-color">Color</label>
                    <input type="color" class="form-control form-control-color" id="event-color" name="color" value="#3788d8" data-testid="input-color">
                  </div>

                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-testid="cancel-btn">Cancelar</button>
                <button type="submit" form="eventForm" class="btn btn-primary" data-testid="save-btn">Guardar</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Modal de Detalle con Eliminar -->
        <div class="modal fade" id="eventDetailModal" tabindex="-1" aria-labelledby="eventDetailLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="eventDetailLabel" data-testid="detail-modal-title"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body" data-testid="detail-modal-body">
                <!-- Detalle se rellenará dinámicamente -->
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="deleteEventBtn" data-testid="delete-btn">Eliminar</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-testid="close-detail-btn">Cerrar</button>
              </div>
            </div>
          </div>
        </div>

    </div>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- FullCalendar JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {

        const calendarEl = document.getElementById('calendar-view');

        // Instancia de FullCalendar
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          selectable: true,
          editable: true,
          eventClick: function(info) {
            showEventDetail(info.event);
          },
          select: function(selectionInfo) {
            openModalForNewEvent(selectionInfo.startStr, selectionInfo.endStr);
          },
          eventDrop: function(dropInfo) {
            updateEventDate(dropInfo.event);
          }
        });

        calendar.render();

        // Cargar eventos del backend
        const loadEvents = async () => {
          try {
            const start = new Date().toISOString().split('T')[0];
            const endDate = new Date();
            endDate.setMonth(endDate.getMonth() + 1);
            const end = endDate.toISOString().split('T')[0];

            const res = await fetch(`/api/events?start=${start}&end=${end}`);
            if (!res.ok) throw new Error('Error al cargar eventos');
            const events = await res.json();

            // Transformar a formato de FullCalendar
            const fcEvents = events.map(ev => ({
              id: ev.id,
              title: ev.titulo,
              start: ev.fecha_inicio,
              end: ev.fecha_fin,
              backgroundColor: ev.color || '#3788d8',
              borderColor: ev.color || '#3788d8'
            }));

            calendar.removeAllEvents();
            fcEvents.forEach(e => calendar.addEvent(e));
          } catch (err) {
            console.error(err);
            alert('No se pudieron cargar los eventos.');
          }
        };

        loadEvents();

        // Modal para crear evento
        const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));

        const openModalForNewEvent = (startStr, endStr) => {
          document.getElementById('eventForm').reset();
          document.getElementById('event-id').value = '';
          document.getElementById('event-title').focus();

          // Rellenar fechas por defecto
          document.getElementById('event-start').value = startStr.slice(0, 16);
          document.getElementById('event-end').value = endStr ? endStr.slice(0, 16) : startStr.slice(0, 16);

          eventModal.show();
        };

        // Manejo de envío del formulario (crear/actualizar)
        document.getElementById('eventForm').addEventListener('submit', async (e) => {
          e.preventDefault();

          const id = document.getElementById('event-id').value;
          const payload = {
            titulo: document.getElementById('event-title').value,
            descripcion: document.getElementById('event-description').value,
            fecha_inicio: document.getElementById('event-start').value,
            fecha_fin: document.getElementById('event-end').value,
            color: document.getElementById('event-color').value
          };

          try {
            const url = id ? `/api/events/${id}` : '/api/events';
            const method = id ? 'PUT' : 'POST';

            const res = await fetch(url, {
              method: method,
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (!res.ok) throw new Error('Error al guardar el evento');

            eventModal.hide();
            loadEvents();
          } catch (err) {
            console.error(err);
            alert('No se pudo guardar el evento.');
          }
        });

        // Mostrar detalle de evento en modal
        const eventDetailModal = new bootstrap.Modal(document.getElementById('eventDetailModal'));
        let currentEventId = null;

        const showEventDetail = (fcEvent) => {
          currentEventId = fcEvent.id;
          document.getElementById('detail-modal-title').textContent = fcEvent.title;
          document.getElementById('detail-modal-body').innerHTML = `<p><strong>Fecha:</strong> ${fcEvent.start.toLocaleString()} - ${fcEvent.end ? fcEvent.end.toLocaleString() : ''}</p>`;

          eventDetailModal.show();
        };

        // Borrar evento
        document.getElementById('deleteEventBtn').addEventListener('click', async () => {
          if (!currentEventId) return;

          try {
            const res = await fetch(`/api/events/${currentEventId}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('Error al eliminar');

            eventDetailModal.hide();
            loadEvents();
          } catch (err) {
            console.error(err);
            alert('No se pudo eliminar el evento.');
          }
        });

        // Actualizar fecha al arrastrar
        const updateEventDate = async (fcEvent) => {
          try {
            const payload = {
              fecha_inicio: fcEvent.start.toISOString(),
              fecha_fin: fcEvent.end ? fcEvent.end.toISOString() : null
            };

            const res = await fetch(`/api/events/${fcEvent.id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (!res.ok) throw new Error('Error al actualizar fecha');

          } catch (err) {
            console.error(err);
            alert('No se pudo actualizar la fecha del evento.');
            // Revertir el cambio visual
            loadEvents();
          }
        };

      });
    </script>
</body>
</html>